<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Patient Dashboard - Health Nova">
    <title>Patient Dashboard - Health Nova</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background: #f8f9fa; color: #333; }

        /* Top Navigation */
        .top-navbar {
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            padding: 0.75rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .navbar-brand { font-weight: 700; font-size: 1.3rem; text-decoration: none; }
        .user-dropdown {
            display: flex; align-items: center; gap: 10px; padding: 8px 16px;
            background: #f0f4ff; border-radius: 25px; cursor: pointer;
            border: 1px solid #e0e7ff; transition: all 0.3s ease;
        }
        .user-dropdown:hover { background: #e0e7ff; }
        .user-avatar {
            width: 32px; height: 32px; background: #1e88e5; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; color: white;
        }

        /* Service Menu */
        .service-menu { background: white; padding: 25px 0; border-bottom: 1px solid #e9ecef; }
        .service-icons { display: flex; justify-content: center; gap: 40px; flex-wrap: wrap; }
        .service-item {
            text-align: center; cursor: pointer; transition: transform 0.3s ease;
            text-decoration: none; color: inherit; min-width: 100px;
        }
        .service-item:hover { transform: translateY(-5px); color: #1e88e5; }
        .service-icon-wrapper {
            width: 65px; height: 65px; margin: 0 auto 10px;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
        }
        .service-icon-wrapper i { font-size: 1.8rem; color: #1e88e5; }

        /* Dashboard Components */
        .main-content { padding: 30px 0; }
        .consultation-banner {
            background: white; border-radius: 16px; padding: 30px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06); margin-bottom: 30px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .btn-consult {
            padding: 12px 35px; background: linear-gradient(135deg, #1e88e5 0%, #1565c0 100%);
            color: white; border-radius: 25px; font-weight: 600; text-decoration: none;
            transition: all 0.3s ease;
        }
        .btn-consult:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(30,136,229,0.4); color: white; }

        .promo-card {
            background: linear-gradient(135deg, #f3e7ff 0%, #e1d5ff 100%);
            border-radius: 16px; padding: 30px; display: flex; align-items: center; gap: 30px;
            margin-bottom: 30px;
        }
        .btn-promo {
            padding: 10px 30px; background: #7c4dff; color: white; border: none;
            border-radius: 25px; font-weight: 600; text-decoration: none; display: inline-block;
        }

        .dashboard-cards {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }
        .dash-card {
            background: white; border-radius: 16px; padding: 25px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06); transition: all 0.3s ease; cursor: pointer;
        }
        .dash-card:hover { transform: translateY(-5px); box-shadow: 0 6px 20px rgba(0,0,0,0.1); }
        .dash-card-icon {
            width: 50px; height: 50px; border-radius: 12px; margin-bottom: 15px;
            display: flex; align-items: center; justify-content: center; font-size: 1.5rem;
        }
        .blue { background: #e3f2fd; color: #1e88e5; }
        .green { background: #e8f5e9; color: #43a047; }
        .orange { background: #fff3e0; color: #ff9800; }
        .purple { background: #f3e5f5; color: #9c27b0; }

        .activity-section { background: white; border-radius: 16px; padding: 25px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); }
        .activity-item {
            display: flex; align-items: center; gap: 15px; padding: 15px;
            border-radius: 12px; transition: background 0.2s ease; cursor: pointer;
        }
        .activity-item:hover { background: #f8f9fa; }
        
        .footer { background: white; border-top: 1px solid #e0e0e0; margin-top: 60px; padding: 30px 0; }

        /* Floating AI Chat Button */
        .floating-ai-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #1e88e5 0%, #1565c0 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(30,136,229,0.4);
            transition: all 0.3s ease;
            z-index: 9999;
            border: none;
            animation: pulse-glow 2s infinite;
        }
        .floating-ai-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(30,136,229,0.6);
        }
        @keyframes pulse-glow {
            0%, 100% {
                box-shadow: 0 4px 20px rgba(30,136,229,0.4);
            }
            50% {
                box-shadow: 0 4px 30px rgba(30,136,229,0.7);
            }
        }
        .ai-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #4caf50;
            color: white;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            border: 2px solid white;
        }
        .ai-tooltip {
            position: absolute;
            right: 70px;
            bottom: 15px;
            background: white;
            padding: 10px 15px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.15);
            white-space: nowrap;
            font-size: 0.9rem;
            font-weight: 500;
            color: #333;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .floating-ai-btn:hover .ai-tooltip {
            opacity: 1;
        }
        .ai-tooltip::after {
            content: '';
            position: absolute;
            right: -8px;
            top: 50%;
            transform: translateY(-50%);
            border: 8px solid transparent;
            border-left-color: white;
        }

        @media (max-width: 768px) {
            .consultation-banner { flex-direction: column; text-align: center; gap: 20px; }
            .promo-card { flex-direction: column; text-align: center; }
            .floating-ai-btn {
                bottom: 20px;
                right: 20px;
                width: 55px;
                height: 55px;
                font-size: 1.6rem;
            }
            .ai-tooltip {
                display: none;
            }
        }
    </style>
</head>
<body>

    <nav class="top-navbar">
        <div class="container d-flex justify-content-between align-items-center">
            <a class="navbar-brand text-primary" href="../landing.html"><i class="bi bi-heart-pulse-fill"></i> Health Nova</a>
            <div class="d-flex align-items-center gap-3">
                <div class="dropdown">
                    <button class="btn btn-light btn-sm dropdown-toggle language-dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-translate me-1"></i><span data-i18n="language">Language</span>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item language-option" href="#" data-lang="en">English</a></li>
                        <li><a class="dropdown-item language-option" href="#" data-lang="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</a></li>
                        <li><a class="dropdown-item language-option" href="#" data-lang="mr">‡§Æ‡§∞‡§æ‡§†‡•Ä</a></li>
                    </ul>
                </div>
                <button class="btn btn-outline-primary btn-sm" onclick="toggleChatbot()">
                    <i class="bi bi-chat-dots"></i> <span data-i18n="ai_assistant">AI Assistant</span>
                </button>
                <div class="dropdown">
                    <div class="user-dropdown" data-bs-toggle="dropdown">
                    <div class="user-avatar"><i class="bi bi-person"></i></div>
                    <div class="d-none d-sm-block">
                        <div style="font-weight:600; font-size:0.85rem;" id="userName">Patient</div>
                        <div style="font-size:0.7rem; color:#888;" id="userInfo">Loading...</div>
                    </div>
                    <i class="bi bi-chevron-down ms-1"></i>
                </div>
                <ul class="dropdown-menu dropdown-menu-end shadow border-0">
                    <li><a class="dropdown-item" href="profile.html"><i class="bi bi-person me-2"></i> <span data-i18n="profile">Profile</span></a></li>
                    <li><a class="dropdown-item" href="medical_history.html"><i class="bi bi-clock-history me-2"></i> <span data-i18n="medical_history">Medical History</span></a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="../landing.html"><i class="bi bi-box-arrow-right me-2"></i> <span data-i18n="logout">Sign out</span></a></li>
                </ul>
            </div>
            </div>
        </div>
    </nav>

    <div class="service-menu">
        <div class="container">
            <div class="service-icons">
                <a href="#appointmentsContainer" onclick="showVideoConsultInfo(); return false;" class="service-item">
                    <div class="service-icon-wrapper"><i class="bi bi-camera-video"></i></div>
                    <h6>Video Consult</h6>
                </a>
                <a href="pharmacy.html" class="service-item">
                    <div class="service-icon-wrapper"><i class="bi bi-capsule"></i></div>
                    <h6>Medicines</h6>
                </a>
                <a href="lab-tests.html" class="service-item">
                    <div class="service-icon-wrapper"><i class="bi bi-microscope"></i></div>
                    <h6>Lab Tests</h6>
                </a>
                <a href="insurance.html" class="service-item">
                    <div class="service-icon-wrapper"><i class="bi bi-shield-check"></i></div>
                    <h6>Insurance</h6>
                </a>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="container">
            <div class="consultation-banner">
                <h3>Consult with Top Doctors Online, 24√ó7</h3>
                <a href="booking.html" class="btn-consult">Start Consultation <i class="bi bi-arrow-right ms-2"></i></a>
            </div>

            <div class="promo-card">
                <div class="promo-image d-none d-md-block">
                    <i class="bi bi-stars" style="font-size: 4rem; color: #7c4dff;"></i>
                </div>
                <div class="promo-content">
                    <h3>New Year Health Checkup!</h3>
                    <p>Comprehensive health packages starting at <strong>‚Çπ999*</strong>. Valid until Jan 31.</p>
                    <a href="offers.html" class="btn-promo">GRAB DEAL</a>
                </div>
            </div>

            <div class="dashboard-cards">
                <div class="dash-card" onclick="location.href='symptoms.html'">
                    <div class="dash-card-icon blue"><i class="bi bi-clipboard2-pulse"></i></div>
                    <h5 data-i18n="add_symptoms">Add Symptoms</h5>
                    <p class="small text-muted">Tell us what you're feeling for instant guidance.</p>
                    <div class="text-primary fw-bold mt-2" data-i18n="add_now">Add Now <i class="bi bi-arrow-right"></i></div>
                </div>
                <div class="dash-card" onclick="location.href='reports.html'">
                    <div class="dash-card-icon green"><i class="bi bi-file-earmark-medical"></i></div>
                    <h5 data-i18n="view_reports">View Reports</h5>
                    <p class="small text-muted">Access your lab results and scan reports.</p>
                    <div class="text-success fw-bold mt-2" data-i18n="view_all">View All <i class="bi bi-arrow-right"></i></div>
                </div>
                <div class="dash-card" onclick="location.href='appointments.html'">
                    <div class="dash-card-icon orange"><i class="bi bi-calendar-event"></i></div>
                    <h5 data-i18n="appointments">Appointments</h5>
                    <p class="small text-muted">Manage your upcoming doctor visits.</p>
                    <div class="text-warning fw-bold mt-2" data-i18n="check_status">Check Status <i class="bi bi-arrow-right"></i></div>
                </div>
            </div>

            <!-- UPCOMING APPOINTMENTS with JOIN CONSULTATION -->
            <div class="activity-section mb-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="m-0"><i class="bi bi-calendar-check me-2 text-primary"></i><span data-i18n="my_appointments">My Appointments</span></h5>
                    <a href="appointments.html" class="text-decoration-none" data-i18n="view_all">View All</a>
                </div>
                <div id="appointmentsLoading" class="text-center py-4">
                    <div class="spinner-border text-primary spinner-border-sm"></div>
                    <p class="mt-2 text-muted small">Loading appointments...</p>
                </div>
                <div id="appointmentsContainer" class="d-none">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th data-i18n="date_time">Date & Time</th>
                                    <th data-i18n="doctor">Doctor</th>
                                    <th data-i18n="reason">Reason</th>
                                    <th data-i18n="status">Status</th>
                                    <th class="text-end" data-i18n="action">Action</th>
                                </tr>
                            </thead>
                            <tbody id="appointmentsTableBody">
                                <!-- Appointments will be loaded here dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div id="noAppointments" class="text-center py-4 d-none">
                    <i class="bi bi-calendar-x text-muted" style="font-size: 2.5rem;"></i>
                    <p class="mt-2 text-muted" data-i18n="no_appointments">No upcoming appointments</p>
                    <a href="booking.html" class="btn btn-primary btn-sm mt-2" data-i18n="book_appointment">Book Appointment</a>
                </div>
            </div>

            <div class="activity-section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="m-0"><i class="bi bi-clock-history me-2"></i>Recent Activity</h5>
                    <a href="activity.html" class="text-decoration-none">View All</a>
                </div>
                <div id="activity-list">
                    <div class="text-center py-4 text-muted">Loading your recent updates...</div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer mt-auto">
        <div class="container text-center">
            <p class="mb-1">&copy; 2026 Health Nova. All rights reserved.</p>
            <p class="text-muted small"><i class="bi bi-telephone"></i> Helpline: 1800-123-4567</p>
        </div>
    </footer>

    <!-- Floating AI Assistant Button -->
    <button class="floating-ai-btn" onclick="window.location.href='ai-chat.html'" title="AI Health Assistant">
        <i class="bi bi-robot"></i>
        <span class="ai-badge">AI</span>
        <div class="ai-tooltip">
            <i class="bi bi-stars me-1"></i>Ask Health Nova AI
        </div>
    </button>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Socket.IO for real-time meeting notifications -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.0/socket.io.min.js"></script>
    <script src="/js/i18n.js"></script>

    <!-- Real-time Meeting Notification System -->
    <script>
        // ===================================================
        // SOCKET.IO REAL-TIME MEETING NOTIFICATIONS
        // ===================================================
        // Patient receives instant notification when doctor starts a meeting
        // No polling required - Socket.IO pushes events in real-time

        let notificationSocket = null;
        let currentUserId = null;

        /**
         * Initialize Socket.IO connection for meeting notifications
         * Called after page load and authentication check
         */
        function initMeetingNotifications() {
            // Get user ID from session storage
            const userData = sessionStorage.getItem('user');
            if (userData) {
                try {
                    const user = JSON.parse(userData);
                    currentUserId = user.id;
                } catch (e) {
                    console.error('Error parsing user data:', e);
                    return;
                }
            }

            if (!currentUserId) {
                console.warn('No user ID found, skipping Socket.IO registration');
                return;
            }

            // Connect to Socket.IO server
            notificationSocket = io({
                transports: ['websocket', 'polling'],
                reconnection: true,
                reconnectionAttempts: 5,
                reconnectionDelay: 1000
            });

            notificationSocket.on('connect', () => {
                console.log('Connected to notification server');
                
                // Register for personal notifications
                notificationSocket.emit('register_user', {
                    user_id: currentUserId,
                    user_type: 'patient'
                });
            });

            notificationSocket.on('registered', (data) => {
                console.log('Registered for notifications:', data);
            });

            // ========================================
            // MEETING STARTED - Doctor has started the consultation
            // ========================================
            notificationSocket.on('meeting_started', (data) => {
                console.log('Meeting started notification received:', data);
                
                // Show notification modal
                showMeetingNotification(data);
                
                // Update the specific appointment's join button if visible
                const joinBtn = document.getElementById(`join-btn-${data.appointment_id}`);
                if (joinBtn) {
                    joinBtn.disabled = false;
                    joinBtn.className = 'btn btn-success btn-sm';
                    joinBtn.innerHTML = '<i class="bi bi-camera-video me-1"></i>Join Now!';
                    
                    // Add pulse animation
                    joinBtn.classList.add('pulse-animation');
                }

                const statusMsg = document.getElementById(`status-msg-${data.appointment_id}`);
                if (statusMsg) {
                    statusMsg.innerHTML = '<span class="text-success fw-semibold"><i class="bi bi-broadcast me-1"></i>Live Now!</span>';
                }
            });

            // ========================================
            // MEETING ENDED - Doctor has ended the consultation
            // ========================================
            notificationSocket.on('meeting_ended', (data) => {
                console.log('Meeting ended notification received:', data);
                
                // Show ended message
                showMeetingEndedNotification(data);
                
                // Update the specific appointment's button
                const joinBtn = document.getElementById(`join-btn-${data.appointment_id}`);
                if (joinBtn) {
                    joinBtn.disabled = true;
                    joinBtn.className = 'btn btn-secondary btn-sm';
                    joinBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Completed';
                    joinBtn.classList.remove('pulse-animation');
                }

                const statusMsg = document.getElementById(`status-msg-${data.appointment_id}`);
                if (statusMsg) {
                    statusMsg.innerHTML = '<span class="text-muted">Consultation ended</span>';
                }
            });

            notificationSocket.on('disconnect', () => {
                console.log('Disconnected from notification server');
            });

            notificationSocket.on('error', (error) => {
                console.error('Socket.IO error:', error);
            });
        }

        /**
         * Show a prominent notification when doctor starts the meeting
         */
        function showMeetingNotification(data) {
            // Remove any existing notification modal
            const existingModal = document.getElementById('meetingNotificationModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Create notification modal
            const modalHTML = `
                <div class="modal fade" id="meetingNotificationModal" tabindex="-1" data-bs-backdrop="static">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content border-0 shadow-lg">
                            <div class="modal-body text-center p-4">
                                <div class="meeting-notification-icon mb-3">
                                    <i class="bi bi-camera-video-fill text-success" style="font-size: 3rem;"></i>
                                </div>
                                <h4 class="fw-bold text-success mb-2">
                                    <i class="bi bi-broadcast me-2"></i>Meeting is Live!
                                </h4>
                                <p class="text-muted mb-3">
                                    <strong>${data.doctor_name || 'Your doctor'}</strong> has started the consultation.<br>
                                    Click below to join now.
                                </p>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-success btn-lg" onclick="joinMeetingNow(${data.appointment_id}, '${data.doctor_name || 'Doctor'}')">
                                        <i class="bi bi-camera-video me-2"></i>Join Meeting Now
                                    </button>
                                    <button class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                        Join Later
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            const modal = new bootstrap.Modal(document.getElementById('meetingNotificationModal'));
            modal.show();

            // Play notification sound (optional)
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleylUUZTF6eeTXkw9TlqZ5d2qWw==');
                audio.volume = 0.3;
                audio.play().catch(() => {});
            } catch (e) {}
        }

        /**
         * Show notification when meeting has ended
         */
        function showMeetingEndedNotification(data) {
            // Create a toast notification
            const toastHTML = `
                <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
                    <div id="meetingEndedToast" class="toast" role="alert">
                        <div class="toast-header">
                            <i class="bi bi-info-circle text-primary me-2"></i>
                            <strong class="me-auto">Consultation Ended</strong>
                            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                        </div>
                        <div class="toast-body">
                            ${data.message || 'The doctor has ended the consultation.'}
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', toastHTML);
            const toast = new bootstrap.Toast(document.getElementById('meetingEndedToast'));
            toast.show();
        }

        /**
         * Join meeting immediately - called from notification modal
         */
        function joinMeetingNow(appointmentId, doctorName) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('meetingNotificationModal'));
            if (modal) modal.hide();

            // Get patient name
            let patientName = 'Patient';
            const userData = sessionStorage.getItem('user');
            if (userData) {
                try {
                    const user = JSON.parse(userData);
                    patientName = user.full_name || 'Patient';
                } catch (e) {}
            }

            // Redirect to video call page
            const videoUrl = `/patient/video-call.html?appointment_id=${appointmentId}&type=patient&name=${encodeURIComponent(patientName)}`;
            window.location.href = videoUrl;
        }
    </script>

    <!-- CSS for notification animations -->
    <style>
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }
        .pulse-animation {
            animation: pulse 1.5s infinite;
        }
        .meeting-notification-icon {
            animation: pulse 1.5s infinite;
            display: inline-block;
            border-radius: 50%;
            padding: 15px;
            background: rgba(40, 167, 69, 0.1);
        }
    </style>

    <script>
        // Check authentication and load user data on page load
        window.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
            loadUserData();
            // Initialize real-time meeting notifications
            initMeetingNotifications();
        });

        function checkAuthentication() {
            // Check if user is authenticated
            const isAuthenticated = sessionStorage.getItem('isAuthenticated');
            if (!isAuthenticated || isAuthenticated !== 'true') {
                // Redirect to login if not authenticated
                window.location.href = '../login.html';
                return;
            }
        }

        function loadUserData() {
            // Fetch user data from backend API
            fetch('/patient/current-user')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' && data.data.full_name) {
                        // Update UI with user information
                        document.getElementById('userName').textContent = data.data.full_name;
                        document.getElementById('userInfo').textContent = `ID: #${data.data.user_id || 'N/A'}`;
                    } else {
                        // Fallback to sessionStorage if API call fails
                        const userData = sessionStorage.getItem('user');
                        if (userData) {
                            const user = JSON.parse(userData);
                            document.getElementById('userName').textContent = user.full_name || 'Patient';
                            document.getElementById('userInfo').textContent = `ID: #${user.id || 'N/A'}`;
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching user data:', error);
                    // Fallback to sessionStorage on error
                    const userData = sessionStorage.getItem('user');
                    if (userData) {
                        const user = JSON.parse(userData);
                        document.getElementById('userName').textContent = user.full_name || 'Patient';
                        document.getElementById('userInfo').textContent = `ID: #${user.id || 'N/A'}`;
                    }
                });
        }

        // Data to simulate a backend response
        const mockData = [
            { id: 101, type: 'report', title: 'Full Body Blood Test', date: 'Jan 28, 2026', status: 'Completed', color: 'text-success', icon: 'bi-file-earmark-check' },
            { id: 102, type: 'visit', title: 'Consultation: Dr. Sharma', date: 'Jan 25, 2026', status: 'Completed', color: 'text-success', icon: 'bi-person-check' },
            { id: 103, type: 'lab', title: 'X-Ray Chest PA View', date: 'Jan 30, 2026', status: 'Upcoming', color: 'text-primary', icon: 'bi-calendar-date' }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            renderActivity(mockData);
        });

        function renderActivity(data) {
            const container = document.getElementById('activity-list');
            container.innerHTML = data.map(item => `
                <div class="activity-item" onclick="viewDetails(${item.id})">
                    <div class="user-avatar" style="background:#f0f4ff; color:#1e88e5;">
                        <i class="bi ${item.icon}"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="mb-0">${item.title}</h6>
                        <small class="text-muted">${item.date}</small>
                    </div>
                    <span class="fw-bold small ${item.color}">${item.status}</span>
                </div>
            `).join('');
        }

        function viewDetails(id) {
            window.location.href = `activity.html#activity-${id}`;
        }

        function handleLogout() {
            if(confirm("Are you sure you want to sign out?")) {
                // Clear session storage
                sessionStorage.removeItem('user');
                sessionStorage.removeItem('isAuthenticated');
                
                // Call logout API
                fetch('http://127.0.0.1:5000/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                }).then(() => {
                    // Redirect to login page
                    window.location.href = '../login.html';
                }).catch(error => {
                    console.error('Logout error:', error);
                    // Still redirect even if API call fails
                    window.location.href = '../login.html';
                });
            }
        }

        /**
         * Show information about video consultation
         * Video meetings are appointment-based - no manual room IDs needed
         */
        function showVideoConsultInfo() {
            const modalHTML = `
                <div class="modal fade" id="videoConsultInfoModal" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content border-0 shadow-lg">
                            <div class="modal-header border-0 bg-primary text-white">
                                <h5 class="modal-title">
                                    <i class="bi bi-camera-video me-2"></i>Video Consultation
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body p-4">
                                <div class="text-center mb-4">
                                    <div class="bg-primary-soft text-primary rounded-circle mx-auto mb-3" style="width: 80px; height: 80px; display: flex; align-items: center; justify-content: center;">
                                        <i class="bi bi-calendar-check" style="font-size: 2.5rem;"></i>
                                    </div>
                                    <h5 class="fw-bold">Appointment-Based Video Calls</h5>
                                </div>
                                
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    <strong>How it works:</strong>
                                </div>
                                
                                <ol class="ps-3">
                                    <li class="mb-2">üìÖ <strong>Book an appointment</strong> with your doctor</li>
                                    <li class="mb-2">‚è∞ <strong>Wait for your scheduled time</strong></li>
                                    <li class="mb-2">üîî <strong>Get instant notification</strong> when doctor starts the meeting</li>
                                    <li class="mb-2">üé• <strong>Click "Join Now"</strong> to connect - No room IDs needed!</li>
                                </ol>
                                
                                <div class="alert alert-success mt-3">
                                    <i class="bi bi-shield-check me-2"></i>
                                    Secure, seamless, and automatic - your doctor controls when meetings start!
                                </div>
                                
                                <div class="text-center mt-4">
                                    <p class="text-muted small">Check your appointments below for upcoming consultations</p>
                                    <button class="btn btn-primary" data-bs-dismiss="modal" onclick="document.getElementById('appointmentsContainer').scrollIntoView({behavior: 'smooth'});">
                                        View My Appointments
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existing = document.getElementById('videoConsultInfoModal');
            if (existing) existing.remove();
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            const modal = new bootstrap.Modal(document.getElementById('videoConsultInfoModal'));
            modal.show();
        }
        
        // Chatbot toggle function
        function toggleChatbot() {
            const widget = document.getElementById('chatbotWidget');
            if (widget) {
                widget.style.display = widget.style.display === 'none' ? 'flex' : 'none';
            }
        }

        // ========================================
        // VIDEO CONSULTATION - PATIENT CONTROLLED JOIN
        // ========================================

        /**
         * Load patient's appointments
         * Shows appointments with conditional Join buttons
         */
        async function loadPatientAppointments() {
            const token = localStorage.getItem('token');
            
            if (!token) {
                console.warn('No token found');
                showNoAppointments();
                return;
            }
            
            try {
                // Get upcoming scheduled appointments
                const appointments = await fetchMyAppointments({
                    status: 'scheduled',
                    upcoming: true
                });
                
                const loading = document.getElementById('appointmentsLoading');
                const container = document.getElementById('appointmentsContainer');
                const noAppointments = document.getElementById('noAppointments');
                const tableBody = document.getElementById('appointmentsTableBody');
                
                loading.classList.add('d-none');
                
                if (appointments.length === 0) {
                    noAppointments.classList.remove('d-none');
                    return;
                }
                
                // Render appointments
                tableBody.innerHTML = appointments.slice(0, 5).map(apt => {
                    const aptDate = new Date(apt.appointment_date);
                    const dateStr = aptDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    const timeStr = aptDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    
                    // Unique IDs for this appointment's elements
                    const joinBtnId = `join-btn-${apt.id}`;
                    const statusMsgId = `status-msg-${apt.id}`;
                    
                    return `
                        <tr>
                            <td>
                                <div class="fw-semibold">${dateStr}</div>
                                <div class="text-muted small">${timeStr}</div>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="bg-primary-soft text-primary rounded-circle me-2 d-flex align-items-center justify-content-center" style="width:32px; height:32px; font-size: 0.8rem;">
                                        ${getInitials(apt.doctor_name || 'Doctor')}
                                    </div>
                                    ${apt.doctor_name || 'Doctor'}
                                </div>
                            </td>
                            <td class="text-muted small">${apt.reason || 'General consultation'}</td>
                            <td>
                                <span class="badge bg-primary-soft text-primary rounded-pill px-3">${apt.status}</span>
                                <div id="${statusMsgId}" class="small text-muted mt-1"></div>
                            </td>
                            <td class="text-end">
                                <button 
                                    id="${joinBtnId}" 
                                    class="btn btn-secondary btn-sm" 
                                    onclick="joinConsultation(${apt.id})" 
                                    disabled>
                                    <i class="bi bi-clock me-1"></i>Waiting for Doctor...
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                container.classList.remove('d-none');
                
                // Start polling for each appointment
                appointments.slice(0, 5).forEach(apt => {
                    const joinBtnId = `join-btn-${apt.id}`;
                    const statusMsgId = `status-msg-${apt.id}`;
                    pollMeetingStatus(apt.id, joinBtnId, statusMsgId);
                });
                
            } catch (error) {
                console.error('Error loading appointments:', error);
                showNoAppointments();
            }
        }

        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
        }

        function showNoAppointments() {
            document.getElementById('appointmentsLoading').classList.add('d-none');
            document.getElementById('noAppointments').classList.remove('d-none');
        }

        // Load appointments on page load (after existing DOMContentLoaded)
        // Update the existing DOMContentLoaded to include appointment loading
        const originalDOMContentLoaded = document.readyState === 'loading';
        if (originalDOMContentLoaded) {
            document.addEventListener('DOMContentLoaded', function() {
                loadPatientAppointments();
            });
        } else {
            // DOM already loaded
            loadPatientAppointments();
        }
    </script>
    
    <!-- Include Video Consultation Manager -->
    <script src="../js/video-consultation.js"></script>
    
    <!-- Chatbot Widget -->
    <div id="chatbotWidget" class="chatbot-widget" style="display: none;">
        <div class="chatbot-header">
            <div>
                <i class="bi bi-robot"></i>
                <span>Health Nova Assistant</span>
            </div>
            <button class="btn-close-chat" onclick="toggleChatbot()">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="chatbot-messages" id="chatMessages"></div>
        <div class="chatbot-input">
            <form id="chatForm">
                <input type="text" id="chatInput" placeholder="Type your message..." autocomplete="off">
                <button type="submit"><i class="bi bi-send-fill"></i></button>
            </form>
        </div>
    </div>
    
    <!-- Razorpay Checkout Script -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    
    <!-- Razorpay Integration -->
    <script src="../js/razorpay-integration.js"></script>
    
    <!-- Chatbot Integration -->
    <script src="../js/chatbot-integration.js"></script>
    
    <style>
        .chatbot-widget { position: fixed; bottom: 20px; right: 20px; width: 380px; max-width: 90vw; height: 500px; background: white; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); display: flex; flex-direction: column; z-index: 1000; overflow: hidden; }
        .chatbot-header { background: linear-gradient(135deg, #0062ff 0%, #00d2ff 100%); color: white; padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; font-weight: 600; }
        .chatbot-header i { margin-right: 8px; font-size: 1.2rem; }
        .btn-close-chat { background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: 0.3s; }
        .btn-close-chat:hover { background: rgba(255,255,255,0.2); }
        .chatbot-messages { flex: 1; overflow-y: auto; padding: 20px; background: #f8fafc; }
        .chatbot-input { padding: 16px; background: white; border-top: 1px solid #e2e8f0; }
        .chatbot-input form { display: flex; gap: 10px; }
        .chatbot-input input { flex: 1; padding: 10px 16px; border: 1px solid #e2e8f0; border-radius: 24px; outline: none; font-size: 14px; }
        .chatbot-input input:focus { border-color: #0062ff; }
        .chatbot-input button { background: #0062ff; color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
        .chatbot-input button:hover { background: #0052d9; transform: scale(1.05); }
    </style>
</body>
</html>