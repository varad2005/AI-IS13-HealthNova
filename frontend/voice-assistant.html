<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Voice Assistant - Health Nova</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .voice-container {
            background: white;
            border-radius: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 50px 40px;
            max-width: 600px;
            width: 100%;
            text-align: center;
        }

        .voice-header {
            margin-bottom: 40px;
        }

        .voice-header h1 {
            color: #667eea;
            font-weight: 800;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .voice-header p {
            color: #6c757d;
            font-size: 1rem;
        }

        .voice-icon {
            width: 120px;
            height: 120px;
            margin: 0 auto 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 3rem;
            position: relative;
            transition: all 0.3s ease;
        }

        .voice-icon.recording {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7);
            }
            50% {
                box-shadow: 0 0 0 30px rgba(102, 126, 234, 0);
            }
        }

        .record-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(245, 87, 108, 0.4);
            margin: 20px;
        }

        .record-btn:hover {
            transform: scale(1.1);
        }

        .record-btn:active {
            transform: scale(0.95);
        }

        .record-btn.recording {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            animation: recordPulse 1s infinite;
        }

        @keyframes recordPulse {
            0%, 100% {
                box-shadow: 0 10px 30px rgba(250, 112, 154, 0.4);
            }
            50% {
                box-shadow: 0 10px 50px rgba(250, 112, 154, 0.8);
            }
        }

        .status-text {
            font-size: 1.1rem;
            font-weight: 600;
            color: #495057;
            margin: 20px 0;
            min-height: 30px;
        }

        .status-text.recording {
            color: #f5576c;
        }

        .status-text.processing {
            color: #667eea;
        }

        .transcript-box {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            min-height: 80px;
            display: none;
        }

        .transcript-box.show {
            display: block;
        }

        .transcript-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .transcript-text {
            font-size: 1.05rem;
            color: #212529;
            line-height: 1.6;
        }

        .audio-player {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50px;
            padding: 15px 30px;
            margin: 20px 0;
            display: none;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .audio-player.show {
            display: flex;
        }

        .audio-player button {
            background: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            color: #667eea;
        }

        .audio-player button:hover {
            transform: scale(1.1);
        }

        .audio-player .waveform {
            flex: 1;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 3px;
        }

        .audio-player .waveform span {
            width: 3px;
            height: 20px;
            background: rgba(255,255,255,0.7);
            border-radius: 3px;
            animation: wave 1s infinite;
        }

        .audio-player .waveform span:nth-child(2) { animation-delay: 0.1s; }
        .audio-player .waveform span:nth-child(3) { animation-delay: 0.2s; }
        .audio-player .waveform span:nth-child(4) { animation-delay: 0.3s; }
        .audio-player .waveform span:nth-child(5) { animation-delay: 0.4s; }

        @keyframes wave {
            0%, 100% { height: 20px; }
            50% { height: 35px; }
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            color: #667eea;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .instructions {
            background: #e7f3ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
            font-size: 0.9rem;
            color: #495057;
        }

        .spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .voice-container {
                padding: 30px 20px;
            }

            .voice-header h1 {
                font-size: 1.5rem;
            }

            .voice-icon {
                width: 100px;
                height: 100px;
                font-size: 2.5rem;
            }

            .record-btn {
                width: 70px;
                height: 70px;
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
    <button class="back-btn" onclick="window.location.href='landing.html'">
        <i class="bi bi-arrow-left me-2"></i>Back to Home
    </button>

    <div class="voice-container">
        <div class="voice-header">
            <h1><i class="bi bi-mic-fill me-2"></i>AI Voice Assistant</h1>
            <p>Press the button and speak your health question</p>
        </div>

        <div class="instructions">
            <strong><i class="bi bi-info-circle me-2"></i>How to use:</strong><br>
            1. Click the microphone button below<br>
            2. Speak your health question clearly<br>
            3. Wait for AI to process and respond<br>
            4. Listen to the voice response<br><br>
            <em>Note: This assistant provides health education only. Always consult a real doctor for medical advice.</em>
        </div>

        <div class="voice-icon" id="voiceIcon">
            <i class="bi bi-mic-fill"></i>
        </div>

        <button class="record-btn" id="recordBtn" onclick="toggleRecording()">
            <i class="bi bi-mic-fill"></i>
        </button>

        <div class="status-text" id="statusText">
            Ready to listen
        </div>

        <div class="error-message" id="errorMessage"></div>

        <!-- User's transcribed question -->
        <div class="transcript-box" id="transcriptBox">
            <div class="transcript-label">You asked:</div>
            <div class="transcript-text" id="transcriptText"></div>
        </div>

        <!-- AI's text response -->
        <div class="transcript-box" id="responseBox">
            <div class="transcript-label">AI Response:</div>
            <div class="transcript-text" id="responseText"></div>
        </div>

        <!-- Audio playback controls -->
        <div class="audio-player" id="audioPlayer">
            <button onclick="playAudio()">
                <i class="bi bi-play-fill"></i>
            </button>
            <div class="waveform">
                <span></span>
                <span></span>
                <span></span>
                <span></span>
                <span></span>
            </div>
            <button onclick="stopAudio()">
                <i class="bi bi-stop-fill"></i>
            </button>
        </div>

        <audio id="audioElement" style="display: none;"></audio>
    </div>

    <script>
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let audioElement = document.getElementById('audioElement');
        let currentAudioUrl = null;

        async function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        async function startRecording() {
            try {
                // Reset UI
                hideError();
                document.getElementById('transcriptBox').classList.remove('show');
                document.getElementById('responseBox').classList.remove('show');
                document.getElementById('audioPlayer').classList.remove('show');

                // Request microphone access
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Create media recorder
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await sendAudioToBackend(audioBlob);
                    
                    // Stop all tracks
                    stream.getTracks().forEach(track => track.stop());
                };

                // Start recording
                mediaRecorder.start();
                isRecording = true;

                // Update UI
                updateStatus('Listening... Speak now!', 'recording');
                document.getElementById('recordBtn').classList.add('recording');
                document.getElementById('recordBtn').innerHTML = '<i class="bi bi-stop-fill"></i>';
                document.getElementById('voiceIcon').classList.add('recording');

            } catch (error) {
                console.error('Error starting recording:', error);
                showError('Microphone access denied. Please allow microphone access and try again.');
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;

                // Update UI
                updateStatus('Processing...', 'processing');
                document.getElementById('recordBtn').classList.remove('recording');
                document.getElementById('recordBtn').innerHTML = '<i class="bi bi-mic-fill"></i>';
                document.getElementById('voiceIcon').classList.remove('recording');
            }
        }

        async function sendAudioToBackend(audioBlob) {
            try {
                // Show processing state
                updateStatus('Processing your question...', 'processing');

                // Create form data
                const formData = new FormData();
                formData.append('audio', audioBlob, 'recording.webm');

                // Send to backend
                const response = await fetch('/voice/process', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.error || 'Failed to process audio');
                }

                // Display results
                displayResults(data);

            } catch (error) {
                console.error('Error processing audio:', error);
                showError(error.message || 'Failed to process your request. Please try again.');
                updateStatus('Ready to listen', '');
            }
        }

        function displayResults(data) {
            // Show transcription
            document.getElementById('transcriptText').textContent = data.transcribed_text;
            document.getElementById('transcriptBox').classList.add('show');

            // Show AI response
            document.getElementById('responseText').textContent = data.ai_response_text;
            document.getElementById('responseBox').classList.add('show');

            // Setup audio player
            currentAudioUrl = data.audio_url;
            audioElement.src = currentAudioUrl;
            document.getElementById('audioPlayer').classList.add('show');

            // Auto-play the response
            setTimeout(() => {
                playAudio();
            }, 500);

            updateStatus('Tap play to hear response', '');
        }

        function playAudio() {
            if (currentAudioUrl) {
                audioElement.play();
                updateStatus('Playing response...', 'processing');
                
                audioElement.onended = () => {
                    updateStatus('Ready to listen', '');
                };
            }
        }

        function stopAudio() {
            audioElement.pause();
            audioElement.currentTime = 0;
            updateStatus('Ready to listen', '');
        }

        function updateStatus(text, className) {
            const statusEl = document.getElementById('statusText');
            statusEl.textContent = text;
            statusEl.className = 'status-text ' + className;
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.classList.add('show');
        }

        function hideError() {
            document.getElementById('errorMessage').classList.remove('show');
        }

        // Check browser support
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            showError('Your browser does not support audio recording. Please use Chrome, Firefox, or Safari.');
        }
    </script>
</body>
</html>
